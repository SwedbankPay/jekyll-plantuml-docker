name: Test Deploy

on: [push, pull_request]

jobs:
  test-deploy:
    name: Test Deploy
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Shellcheck
      uses: bewuethr/shellcheck-action@v2

    - name: Build docker image
      env:
        GIT_SHA: ${{ github.sha }}
      run: |
        docker build \
          . \
          --file ./.docker/Dockerfile \
          --tag swedbankpay/jekyll-plantuml:${GIT_SHA}

    - name: Test Deploy
      env:
        GIT_SHA: ${{ github.sha }}
        WORK_DIR: ${{ github.workspace }}
        GIT_DEPLOY_DIR: _site
        GIT_DEPLOY_BRANCH: gh-pages
        GIT_DEPLOY_REPO: https://${{ secrets.GITHUB_TOKEN}}@github.com/${{ github.repository }}.git
      run: |
        docker run \
        --volume ${WORK_DIR}/test/jekyll-plantuml:/srv/jekyll \
        --env GIT_DEPLOY_DIR="${GIT_DEPLOY_DIR}" \
        --env GIT_DEPLOY_BRANCH="${GIT_DEPLOY_BRANCH}" \
        --env GIT_DEPLOY_REPO="${GIT_DEPLOY_REPO}" \
        swedbankpay/jekyll-plantuml:${GIT_SHA} \
        deploy
